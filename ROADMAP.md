# Dougless Runtime - Development Roadmap

## Current Status

**Phases 1-6 COMPLETE! ‚úÖ**
- Phase 1: Foundation ‚úÖ
- Phase 2: File System & Modules ‚úÖ  
- Phase 3: Networking & HTTP ‚úÖ
- Phase 4: Security & Permissions ‚úÖ
- Phase 5: Promises & ES6+ ‚úÖ **NEWLY COMPLETED** (Oct 15, 2024)
- Phase 6: WebSockets & Real-time ‚úÖ

All core async features, promises, and ES6+ transpilation are fully implemented, tested, and validated.

## Recently Completed

- ‚úÖ **Config-Based Permissions System** - Project-centric permission model (Oct 17, 2025)
  - `.douglessrc` JSON configuration files
  - Per-project permission definitions (read, write, net, env, run)
  - Automatic config discovery from script directory
  - Cleaner alternative to CLI flags
  - Version-controlled permissions with project code
- ‚úÖ **Phase 5: Promises & ES6+** - Full Promise/A+ implementation with all static methods (Oct 15, 2024)
  - Promise.all(), Promise.race(), Promise.allSettled(), Promise.any()
  - ES6+ transpilation with esbuild (arrow functions, async/await, classes, etc.)
  - Inline source maps for accurate error reporting
- ‚úÖ **Interactive Permissions System** - Context-aware prompts with session caching
- ‚úÖ **Phase 6: WebSockets & Real-time** - Full WebSocket server implementation

## Development Phases

### Phase 1: Foundation ‚úÖ **COMPLETE**

#### Core Infrastructure
- ‚úÖ Basic project structure and Go module setup
- ‚úÖ Core runtime with Goja integration
- ‚úÖ Event loop with proper async operation handling
- ‚úÖ Module registry system with CommonJS-style require()
- ‚úÖ Placeholder implementations for fs, http, and path modules

#### Timer System
- ‚úÖ `setTimeout()` - Schedule one-time delayed execution
- ‚úÖ `setInterval()` - Schedule recurring execution
- ‚úÖ `clearTimeout()` - Cancel pending timeouts
- ‚úÖ `clearInterval()` - Cancel active intervals
- ‚úÖ Proper WaitGroup management for graceful shutdown

#### Console Operations
- ‚úÖ `console.log()`, `console.error()`, `console.warn()` - Standard output
- ‚úÖ `console.time()` / `console.timeEnd()` - Performance measurement
- ‚úÖ `console.table()` - Structured data visualization with table formatting

#### REPL (Interactive Shell)
- ‚úÖ Interactive JavaScript evaluation
- ‚úÖ Multi-line input support (automatic detection)
- ‚úÖ State preservation between commands
- ‚úÖ Special commands (`.help`, `.exit`, `.clear`)
- ‚úÖ Proper error handling and display

---

### Phase 2: File System & Modules ‚úÖ **COMPLETE**

#### Path Module
- ‚úÖ `path.join()` - Join path segments
- ‚úÖ `path.resolve()` - Resolve absolute paths
- ‚úÖ `path.dirname()` - Get directory name
- ‚úÖ `path.basename()` - Get file name
- ‚úÖ `path.extname()` - Get file extension
- ‚úÖ `path.sep` - OS-specific path separator

#### File Module (Unique Global API)
- ‚úÖ `file.read()` - Read file contents
- ‚úÖ `file.write()` - Write data to file
- ‚úÖ `file.readdir()` - List directory contents
- ‚úÖ `file.exists()` - Check if path exists
- ‚úÖ `file.mkdir()` - Create directory
- ‚úÖ `file.rmdir()` - Remove directory
- ‚úÖ `file.unlink()` - Delete file
- ‚úÖ `file.stat()` - Get file/directory information
- ‚úÖ Global access (no `require()` needed!)

---

### Phase 3: Networking & HTTP ‚úÖ **COMPLETE**

#### HTTP Module (Unique Global API)
- ‚úÖ `http.get()` - Make HTTP GET requests with callbacks
- ‚úÖ `http.post()` - Make HTTP POST requests with JSON payload
- ‚úÖ `http.createServer()` - Create HTTP server
- ‚úÖ Server request/response handling
- ‚úÖ Custom header support (`setHeader()`)
- ‚úÖ Response status codes and body content
- ‚úÖ Multiple header values support
- ‚úÖ Global access (no `require()` needed!)

---

### Phase 4: WebSockets & Real-time ‚úÖ **COMPLETE**

#### WebSocket Module
- ‚úÖ `server.websocket(path, callbacks)` - Add WebSocket endpoint to server
- ‚úÖ Real-time bidirectional communication
- ‚úÖ Connection state management (`readyState` property)
- ‚úÖ Browser-compatible API (CONNECTING, OPEN, CLOSING, CLOSED)
- ‚úÖ Thread-safe message sending with mutex protection
- ‚úÖ Broadcasting to multiple clients
- ‚úÖ Event callbacks: `open`, `message`, `close`, `error`
- ‚úÖ `ws.send()`, `ws.close()` methods on connection object

---

### Security & Permissions ‚úÖ **COMPLETE**

#### Permissions System
- ‚úÖ Interactive permission prompting with context awareness
- ‚úÖ CLI flags for explicit permission granting (`--allow-read`, `--allow-write`, `--allow-net`)
- ‚úÖ Context-aware defaults (interactive vs non-interactive)
- ‚úÖ Session-based permission caching for "always" grants
- ‚úÖ Thread-safe permission checking with concurrent access support
- ‚úÖ Clear, actionable error messages
- ‚úÖ Path canonicalization and security (prevents directory traversal)
- ‚úÖ Host matching with wildcard and port support
- ‚úÖ 30-second timeout for interactive prompts

---

### Testing & Quality ‚úÖ

- ‚úÖ **Tests passing** (unit + integration)
- ‚úÖ **~75% code coverage** across all packages
- ‚úÖ **Benchmark suite** for performance tracking
- ‚úÖ **Race condition testing** (thread-safe event loop)
- ‚úÖ Full test coverage for file system and path modules
- ‚úÖ WebSocket examples and documentation

---

## Permissions Enhancements

While the core permissions system is complete, these enhancements will improve usability and developer experience:

### Testing & Validation
- ‚è≥ Unit tests for `CheckWithPrompt` with mock prompter
- ‚è≥ Integration tests for permission caching behavior
- ‚è≥ Tests for context timeout scenarios
- ‚è≥ Tests for concurrent permission checks
- ‚è≥ Tests for `--prompt` and `--no-prompt` flags

### CLI Improvements
- ‚è≥ `--help` flag showing all available commands and options
- ‚è≥ Permission flags documentation in help text
- ‚è≥ Usage examples in help output
- ‚è≥ Version information (`--version` flag)

### Configuration File Support (Config-First Permission Model) ‚úÖ **COMPLETE**

**Vision**: Deprecate CLI flags in favor of a cleaner, more project-centric permission model using configuration files.

#### Production Mode
- ‚úÖ Permissions defined in `.douglessrc` JSON configuration file
- ‚úÖ Config file discovery from script directory
- ‚úÖ Clear error messages for missing or malformed configs
- ‚úÖ JSON parsing with validation

#### Configuration File Format
- ‚úÖ `.douglessrc` - Primary config format (JSON)
- ‚úÖ JSON schema for storing default permissions:
  ```json
  {
    "permissions": {
      "read": ["/data", "./config"],
      "write": ["./output", "./logs"],
      "net": ["api.example.com", "localhost:3000"],
      "env": ["API_KEY", "DATABASE_URL"],
      "run": ["git", "npm"]
    }
  }
  ```
- ‚úÖ Per-project permission profiles
- ‚úÖ Config file validation and error reporting

#### Future Enhancements
- ‚è≥ Two-step interactive prompt flow to build `.douglessrc` during development
- ‚è≥ `.douglessrc.json` - Alternative explicit JSON extension support
- ‚è≥ Cascading config (global `~/.douglessrc` ‚Üí project `.douglessrc`)
- ‚è≥ `dougless init` command to generate config template
- ‚è≥ Comments support in config (use JSONC parser)
- ‚è≥ CLI flag deprecation warnings

### Advanced Features
- ‚è≥ Persistent permission cache across runs
- ‚è≥ Permission audit logging (track what was accessed)
- ‚è≥ Color-coded terminal output for prompts
- ‚è≥ Wildcard patterns in permission grants (`--allow-read=/tmp/*.txt`)
- ‚è≥ Permission profiles (dev, test, prod)

---

## Phase 5: Promises & ES6+ ‚úÖ **COMPLETE**

### Promises & Async/Await
- ‚úÖ Promise constructor and basic Promise operations
- ‚úÖ `Promise.resolve()` and `Promise.reject()`
- ‚úÖ `Promise.all()`, `Promise.race()` - fully implemented and tested!
- ‚úÖ `Promise.allSettled()`, `Promise.any()` - **COMPLETE** (Oct 15, 2024)
- ‚úÖ async/await syntax support (ES6+ transpilation with esbuild)
- ‚úÖ ES6+ transpilation (arrow functions, destructuring, classes, etc.)
- ‚è≥ Promise-based versions of file operations (Future enhancement)
- ‚è≥ Promise-based versions of HTTP operations (Future enhancement)

### Event Emitter Pattern (Future Enhancement)
- ‚è≥ `EventEmitter` class
- ‚è≥ `on()`, `once()`, `emit()`, `removeListener()`
- ‚è≥ Integration with HTTP server events

---

## Next Up: Phase 7 - Crypto & Security

### Cryptographic Functions
- ‚è≥ Hash functions (SHA-256, SHA-512, MD5)
- ‚è≥ HMAC for message authentication
- ‚è≥ Random number generation (cryptographically secure)
- ‚è≥ Base64 encoding/decoding
- ‚è≥ UUID generation

### Additional Security
- ‚è≥ HTTPS support
- ‚è≥ TLS/SSL certificate handling
- ‚è≥ Secure WebSocket (WSS) support

---

## Phase 8: Process & System Integration

### Process Management
- ‚è≥ `process.exit()` - Graceful shutdown
- ‚è≥ `process.env` - Environment variable access (with permissions)
- ‚è≥ `process.argv` - Command-line arguments
- ‚è≥ `process.cwd()` - Current working directory
- ‚è≥ Signal handling (SIGINT, SIGTERM, etc.)

### Subprocess Execution
- ‚è≥ `exec()` - Execute shell commands (with permissions)
- ‚è≥ `spawn()` - Spawn child processes
- ‚è≥ Stream handling for child process I/O

### OS Integration
- ‚è≥ Platform detection
- ‚è≥ System information queries
- ‚è≥ User/group information

---

## Phase 9: Performance & Optimization

### Runtime Optimizations
- ‚è≥ Object pooling for reduced allocations
- ‚è≥ JIT-style code caching
- ‚è≥ Lazy loading of modules
- ‚è≥ Memory profiling and optimization

### Build Optimizations
- ‚è≥ Binary size reduction
- ‚è≥ Startup time improvements
- ‚è≥ Static linking options

### Benchmarking
- ‚è≥ Comprehensive performance benchmarks vs Node.js
- ‚è≥ HTTP server throughput benchmarks
- ‚è≥ File I/O performance benchmarks
- ‚è≥ Memory usage profiling

---

## Post Phase 9: Package Manager

### Core Package Management
- üì¶ Dependency resolution and installation (`dougless install <package>`)
- üì¶ Package manifest (`dougless.json`) with version management
- üì¶ Lock file for reproducible builds (`dougless-lock.json`)
- üì¶ Support for npm registry compatibility
- üì¶ Local module cache and `dougless_modules/` directory
- üì¶ Enhanced `require()` to support external packages

### Package Manager Features
- üì¶ Semantic versioning support
- üì¶ Development vs production dependencies
- üì¶ Script running (`dougless run <script>`)
- üì¶ Package publishing capabilities
- üì¶ Dependency auditing and security checks

---

## Future Considerations

### ES6+ Support
- üéØ Transpilation pipeline (esbuild, Babel, or SWC)
- üéØ Arrow functions, destructuring, template literals
- üéØ Classes and modules (import/export)
- üéØ Async iterators and generators
- üéØ Optional chaining and nullish coalescing

### Advanced Features
- üîÆ Worker threads for parallel execution
- üîÆ Streaming APIs (ReadableStream, WritableStream)
- üîÆ Buffer implementation for binary data
- üîÆ Native addon support
- üîÆ Plugin system for framework extensibility

### Framework Foundation
- üåê Routing system
- üåê Middleware architecture
- üåê Template engine integration
- üåê Database adapters
- üåê Session management
- üåê Authentication/authorization utilities

---

## Phase ‚àû: Become Dependency-Free (Long-term Vision)

**Goal**: Build everything from scratch to maximize learning and understanding.

This is a distant-future, aspirational phase focused on replacing all external dependencies with custom implementations. While we'll use libraries like Goja and esbuild in the short-term for pragmatic development, the ultimate learning goal is to understand these systems deeply enough to build them ourselves.

### Custom JavaScript Engine
**Replace**: Goja  
**Why**: Deep understanding of JavaScript execution, memory management, and runtime internals

#### Core Components
- üî¨ **Lexer**: Tokenize JavaScript source code
  - Character stream processing
  - Token recognition (keywords, identifiers, operators, literals)
  - Position tracking for error reporting
  - Unicode support

- üî¨ **Parser**: Build Abstract Syntax Tree (AST)
  - Recursive descent parsing or Pratt parsing
  - ES5.1 specification compliance initially
  - Operator precedence handling
  - Error recovery and reporting
  - AST node types for all JavaScript constructs

- üî¨ **Bytecode Compiler**: Transform AST to executable bytecode
  - Instruction set design
  - Register or stack-based VM architecture
  - Optimization passes (constant folding, dead code elimination)
  - Symbol table and scope management

- üî¨ **Virtual Machine**: Execute bytecode
  - Instruction dispatch loop
  - Value representation (tagged pointers, NaN boxing, etc.)
  - Memory management and garbage collection
  - Call stack and exception handling
  - Native function integration

- üî¨ **Garbage Collector**: Automatic memory management
  - Mark-and-sweep algorithm
  - Generational collection for performance
  - Incremental/concurrent collection
  - Weak references and finalizers

- üî¨ **Runtime Library**: Built-in JavaScript objects
  - Object, Array, String, Number, Boolean
  - Function, Date, RegExp, Error
  - Math, JSON, console
  - Prototype chain implementation

**Learning Resources**:
- "Crafting Interpreters" by Robert Nystrom
- "Engineering a Compiler" by Cooper & Torczon
- V8 design documentation
- SpiderMonkey source code study

---

### Custom AST Transformer & Transpiler
**Replace**: esbuild  
**Why**: Master code transformation, understand compilation pipeline, enable custom optimizations

#### Transpilation Pipeline
- üî¨ **Parser**: ES2017+ to AST (can reuse from custom engine)
- üî¨ **AST Visitors**: Pattern-based tree traversal
  - Visitor pattern implementation
  - Transform async/await ‚Üí promises
  - Transform arrow functions ‚Üí regular functions
  - Transform let/const ‚Üí var with proper scoping
  - Transform classes ‚Üí constructor functions
  - Transform template literals ‚Üí string concatenation
  - Transform destructuring ‚Üí explicit assignments

- üî¨ **Scope Analyzer**: Track variable bindings
  - Lexical scope tracking
  - Variable hoisting
  - Closure detection
  - Conflict resolution

- üî¨ **Code Generator**: AST back to JavaScript
  - ES5.1 compliant output
  - Source map generation
  - Readable output formatting
  - Optimization opportunities

- üî¨ **Optimization Passes**:
  - Dead code elimination
  - Constant propagation
  - Function inlining
  - Tail call optimization

**Learning Resources**:
- "Compilers: Principles, Techniques, and Tools" (Dragon Book)
- Babel plugin development docs
- AST Explorer for experimentation
- esbuild source code analysis

---

### Custom WebSocket Implementation
**Replace**: gorilla/websocket  
**Why**: Understand network protocols, frame parsing, and real-time communication

#### WebSocket Protocol
- üî¨ **HTTP Upgrade Handling**:
  - Parse upgrade headers
  - Validate WebSocket handshake
  - Generate Sec-WebSocket-Accept key
  - Subprotocol negotiation

- üî¨ **Frame Parser**:
  - Bit-level frame structure parsing
  - Opcode handling (text, binary, close, ping, pong)
  - Masking/unmasking implementation
  - Fragmented message reassembly
  - Control frame handling

- üî¨ **Connection Management**:
  - Connection state machine (CONNECTING, OPEN, CLOSING, CLOSED)
  - Ping/pong keep-alive
  - Graceful close handshake
  - Error handling and recovery

- üî¨ **Message Queue**:
  - Buffered send/receive
  - Backpressure handling
  - Priority queuing

**Learning Resources**:
- RFC 6455 (WebSocket Protocol)
- "TCP/IP Illustrated" by W. Richard Stevens
- Wireshark for protocol analysis
- gorilla/websocket source code study

---

### Custom HTTP Client/Server
**Replace**: net/http (Go standard library)  
**Why**: Master HTTP protocol, connection handling, and server architecture

#### HTTP Implementation
- üî¨ **Request Parser**:
  - HTTP/1.1 request line parsing
  - Header parsing and validation
  - Chunked transfer encoding
  - Content-Length handling
  - URL parsing and query string extraction

- üî¨ **Response Builder**:
  - Status line generation
  - Header formatting
  - Body encoding
  - Chunked responses

- üî¨ **Connection Management**:
  - Keep-alive support
  - Connection pooling
  - Timeout handling
  - Concurrent connection limits

- üî¨ **TLS/SSL**:
  - Certificate validation
  - Encryption/decryption
  - Handshake protocol
  - Session resumption

**Learning Resources**:
- RFC 2616 (HTTP/1.1) and RFC 7540 (HTTP/2)
- "HTTP: The Definitive Guide"
- Go net/http source code
- nginx architecture study

---

### Custom Event Loop
**Replace**: Current event loop (keep but enhance)  
**Why**: Understand async I/O, concurrency patterns, and scheduling

#### Advanced Event Loop
- üî¨ **I/O Multiplexing**:
  - epoll/kqueue integration (platform-specific)
  - Non-blocking I/O
  - Edge-triggered vs level-triggered events

- üî¨ **Task Scheduling**:
  - Priority queues for task management
  - Microtask vs macrotask distinction
  - Fair scheduling algorithms
  - CPU affinity for worker threads

- üî¨ **Timer Management**:
  - Efficient timer wheel or heap
  - Microsecond precision
  - Timer coalescing for efficiency

**Learning Resources**:
- libuv documentation and source
- "The Art of Multiprocessor Programming"
- Linux epoll/BSD kqueue man pages
- Node.js event loop deep dive

---

### Development Approach

**Phase 1: Study & Design** (Per Component)
- üìö Read specifications and RFCs
- üìö Study existing implementations
- üìö Design custom architecture
- üìö Create proof-of-concept prototypes

**Phase 2: Implement & Test**
- üî® Build minimal viable version
- üî® Comprehensive unit tests
- üî® Integration with existing runtime
- üî® Performance benchmarking

**Phase 3: Optimize & Refine**
- ‚ö° Profile and identify bottlenecks
- ‚ö° Optimize hot paths
- ‚ö° Memory usage improvements
- ‚ö° Documentation and examples

**Phase 4: Production Hardening**
- üõ°Ô∏è Edge case handling
- üõ°Ô∏è Security auditing
- üõ°Ô∏è Stress testing
- üõ°Ô∏è Real-world validation

---

### Why This Matters

**Learning Goals**:
- üéì **Deep System Understanding**: Know how things work at the lowest level
- üéì **Problem-Solving Skills**: Face and solve complex engineering challenges
- üéì **Performance Intuition**: Understand why things are fast or slow
- üéì **Debugging Mastery**: Fix issues in code you fully understand
- üéì **Architecture Expertise**: Design large, complex systems from scratch

**Practical Benefits**:
- üöÄ **Custom Optimizations**: Optimize for specific use cases
- üöÄ **No External Dependencies**: Complete control and no supply chain risks
- üöÄ **Tailored Features**: Add exactly what Dougless needs
- üöÄ **Educational Tool**: Serve as learning material for others
- üöÄ **Zero Bloat**: Only include what's necessary

**Timeline**: This is a multi-year journey, tackled one component at a time as learning projects. There's no rush - the goal is deep understanding, not quick completion.

---

## Performance Targets

### Current Goals
- **Startup Time**: < 100ms for basic scripts
- **Memory Usage**: < 50MB for typical applications  
- **HTTP Throughput**: > 10,000 requests/second
- **File I/O**: Comparable to Node.js performance

### Long-term Goals
- Match or exceed Node.js performance for common operations
- Sub-10ms cold start for serverless deployments
- Minimal memory footprint for embedded use cases
- Native speed for hot-path operations

---

## Success Metrics

### Phase Completion Criteria
- ‚úÖ All features implemented and documented
- ‚úÖ Unit tests passing with >70% coverage
- ‚úÖ Integration tests validating real-world usage
- ‚úÖ Performance benchmarks meeting targets
- ‚úÖ Example programs demonstrating capabilities
- ‚úÖ Documentation complete and accurate

---

*Last Updated: October 15, 2024 - Phase 5 (Promises & ES6+) COMPLETE ‚úÖ - All Promise static methods implemented and tested*
